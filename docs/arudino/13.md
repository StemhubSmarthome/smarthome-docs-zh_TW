# 第十三課	藍牙智能燈



## 任務背景

在普通家居中，家用電器和設備一般都是採用手動開關控制，使用過程中很麻煩，有時還會出現觸電的危險，如果能直接使用手機實 APP 現電燈的遠程控制，這樣會更加的安全與便捷。本節課的任務就是製作一款手機 APP，實現遠程控制照明燈的開啟和關閉。
## 器材準備

Arduino BLE-主板、擴展板、電池盒、LED 燈模塊、手機、連接線、數據線。


## 一、了解藍牙智能燈的原理

本課程中製作的藍牙智能燈的原理是通過手機與 Arduino BLE-UNO 進行藍牙連接，然後使用手機 APP 遠程發送無線信號至 BLE-UNO 主板，然後主板控制 LED 燈的亮滅。




## 二、藍牙智能燈APP 製作

2.1	藍牙插件擴展導入
由於 AI2 的通信連接部分的組件缺少 BLE-NANO 的藍牙連接過程中的一些功能，所以需要導入擴展。
1. 點擊組件面板中的“擴展”，再點擊“導入擴展”，如圖 13-1 所示。
                         
         圖 13-1	  圖 13-2

2. 在彈出的窗口點擊“選擇文件”，如圖 13-2 所示；然後找到存放“edu.mit.appinventor.ble.BluetoothLE.aix” 文件的文件選擇該文 件並打開，再點擊“導入”及成功導入藍牙插件

2.2	APP 界面組件設計
上節課我們已經完成智能家居 APP 首頁的製作，可以在其基礎上繼續完成這節課的功能實現。
點擊增加屏幕，確認屏幕名稱為 Screen2，即可看到工作面板多添加了一個 Screen2 的空白頁面，如圖 13-3 所示

	圖 13-3

2、從組件面板中找到需要的組件，然後依次拖到工作面板上，如圖 13-4 所示，然後修改相應的參數等。



圖 13-4

2.3	APP 界面邏輯設計
1、首先實現屏幕的切換，選擇 Screen1 屏幕進入 Screen1 的邏輯設計界面，輸入以下程序：

圖 13-5

2、藍牙邏輯設計。選擇 Screen2,進入屏幕 2 的邏輯設計頁面，在設計藍牙時，首先需要知道設備的 UUID,因此，需要通過通用藍牙測試 APP 先獲取設備的 UUID，先驗證 BLE 是否正常識別的方法：
https://github.com/emakefun/emakefun-Ble-uno/tree/master/TestApp 下載 apk，測試與 BLE-UNO 板通信正常）,驗證設備正常，安裝一個 BLE 測試工具， 打開測試 APP,界面如圖 13-6 示。找到對應的藍牙名（Ble-Nano）並點擊進行 連接，連接後如圖 13-7 示，此時會出現 4 個選項，分別用於測試不同的功能， 同時我們會看到設備的 Service UUID:0000ffe0-0000-1000-8000-00805f9b34fb











 



圖 16-6	圖 13-7

3、选择SK Service 進入会看到特征值UUID (characteristic_uuid):

0000ffe1-0000-1000-8000-00805f9b34fb，如圖 13-8。





圖 13-8

由於後面與 bluno 通訊均需要使用地址，因此首先初始化 2 個全局文本變量，如圖 13-9 所示：
1）ble_service_uuid為藍牙服務的地址，改為：0000ffe0-0000-1000-

8000-00805f9b34fb

2）ble_characteristic_uuid為設備通訊地址，改為：0000ffe1-0000-

1000-8000-00805f9b34fb

圖 13-9

4、接下來為程序開始時打開藍牙獲取權限並掃描周圍藍牙設備：

圖 13-10

5、藍牙打開後開始掃描
如果點擊按鈕時按鈕顯示為“連接 BLE”說明當前藍牙是斷開的， 則停止掃描周圍；
如果點擊按鈕時按鈕顯示為“斷開 BLE”說明當前藍牙已連接，則斷開當前連接的藍牙。










圖 13-11

6、獲取數據：






圖 13-12




7、設置計時器動作：





圖 13-13









圖13-14

8、定義數據發送過程：















圖13-15


9、開燈，關燈按鈕設置






圖13-16


10、連接 BLE 按鈕設置










圖 13-17


11、APP 設計完成之後，用AI2伴侶手機下載, 安裝後打開，界面如圖 13-18 所示
















圖 圖3-18
	

## 三、Arduino BLE-NANO 主板板程序設計

3.1	硬件連接：
把紅綠燈模塊連接在 Arduino BLE-UNO 主板的 D3、D5、D6（P15）號管腳上，其綠色 LED 對應的是 D3 管腳，所以示例程序中控制的是綠色燈。

執行器
主控板
            紅綠燈模塊
            D3、D5、D6
            



3.2	程序示例：
Arduino IDE 程序
String item; 
volatile long time; 
void setup(){
    Serial.begin(9600);
    item = "";
    time = 0;
    pinMode(3, OUTPUT);

}

void loop(){
    if (Serial.available() > 0) {
item = Serial.readStringUntil('.');
if (String(item).equals(String("OPEN"))) { Serial.println("OPEN"); digitalWrite(3,HIGH);
} else if (String(item).equals(String("CLOSE"))) {
    Serial.println("CLOSE");
    digitalWrite(3,LOW);

      }

     }

}
Mixly程序

MagicBlock程序



注意：當下載完程序的時候，需要給 BLE-Nano 斷開電源，重新上電，APP 如果處於打開狀態，需要點擊右上角的退出，然後重新連接，不然無法正常操作BLE-Nano.

## 四、總結
本節課我們學習製作藍牙智能控制燈，進一步鞏固了 APP 的製作，以及掌握了藍牙燈的程序設計原理與製作，實現了 APP 藍牙遠程控制 LED 燈的開啟和熄滅功能。
